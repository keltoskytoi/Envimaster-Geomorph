---
title: "CENITH fillsinks"
author: "Andreas Schönberg"
date: "26 September 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Description

The function CENITH fillsinks is a preprocessing tool to generate a sinks only elevation model (SOM) from a DEM.

NOTE: requires a RSAGA environment!

Development information:
The wrapper writes the input dem to the ".sdat" Saga format and uses the SAGA tools fill sinks to generate a filled dem in ".sdat" format. The ".sdat" raster is loaded projected in the desired projection and saved as ".tif" format. The fucntion uses a tmp folder to save the ".sdat" and ".tif" raster. The original DEM is substracted from the filled dem to get a raster layer with only the sinks (with depth values).


```{r cars}
#' Mandatory: Cenith fill sinks
#'
#' @description Optional: preprocessing tool for Cenith Segmentation of sinks. Requires a SAGA environment.
#' computes a Sinks only elevation model (SOM). 
#' @name Mandatory Cenith  
#' @export Mandatory Cenith

#' @param Mandatory if function: dem - a digital elevation model in tif format
#' @param Mandatory if function: output - the path where the som and filled_dem to be saved
#' predefinition in var is recommended
#' @param Mandatory if function: tmp - a folder to save several rasterlayers (can be deleted later)
#' @param Mandatory if function: minslope - Minimum slope gradient to preserve from cell to cell;
#' with a value of zero sinks are filled up to the spill elevation (which results in flat areas). Unit [Degree]
#' @param Mandatory if function: proj - desired projection for output data, predefinition in var is recommended

cenith_fillsinks <- function(dem,output,tmp,minslope,proj) {
  cat(" ",sep = "\n")
  cat("### Cenith start to fill sinks ###")
  raster::writeRaster(dem,filename=paste0(file.path(tmp),"/dem.sdat"),overwrite = TRUE,NAflag = 0)
  RSAGA::rsaga.geoprocessor(lib = "ta_preprocessor", module = 4,
                            param = list(ELEV =    paste(tmp,"/dem.sgrd", sep = ""), 
                                         WSHED =   paste(tmp,"/wshed.sgrd", sep = ""),
                                         FDIR =    paste(tmp,"/fdir.sgrd", sep = ""),
                                         FILLED =  paste(tmp,"/filled_dem.sgrd", sep = ""),
                                         MINSLOPE = minslope
                            ),
                            show.output.on.console = TRUE, invisible = TRUE,
                            env = env)

  pr4 <- proj
  filled_dem <- raster::raster(file.path(tmp, "filled_dem.sdat"))
  proj4string(filled_dem) <- pr4
  raster::writeRaster(filled_dem,filename=paste0(file.path(output),"/filled_dem.tif"),overwrite = TRUE,NAflag = 0)
  fem <- raster::raster(file.path(output, "filled_dem.tif"))
  
  som <- fem - dem
  raster::writeRaster(som,filename=paste0(file.path(output),"/som.tif"),overwrite = TRUE,NAflag = 0)
  cat(" ",sep = "\n")
  cat("### Cenith finished ###")
}
  
```



```{r pressure, echo=FALSE}

```

